<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html>
<head>
<title>Canvas mandelbrot</title>
<style type="text/css">
#png { 
  color: #039;
  text-decoration: underline;
  }
#png:hover { 
  color: #f30;
  text-decoration: underline;
  }


</style>
<script type="text/javascript">

var sx = 320;
var sy = 240;
var max_iteration, MinX,MaxX,MinY,MaxY,dx,dy,ctx;

var Canvas = function(id,width,height,zindex){
  var c = document.createElement("canvas");
  c.setAttribute("width",width);
  c.setAttribute("height",height);
  c.setAttribute("id",id);
	c.style.zIndex = zindex;
  document.body.appendChild(c);
  return c.getContext("2d");
}


function calc_pixel(ca,cbi) {
	var iteration = 0;
  var old_a;
  var a = 0, b = 0;
  var length;
  do {
    old_a = a;
    a = a*a - b*b + ca;
    b = 2*old_a*b+cbi;
    iteration++;
    length = a*a+b*b;
  } while ((length < 4) && (iteration < max_iteration));
  return iteration;
}

window.addEventListener("load",function ev() {
	ctx = new Canvas("c1",sx,sy,1);
  document.getElementById("c1").addEventListener("click",selectMinMax,false);
  document.getElementById("png").addEventListener("click",convPNG,false);
},false);

function plotSet() {
  for (var y = 0; y < sy;y++ ) {
      for (var x = 0; x < sx; x++) {
        ctx.save();
        c = calc_pixel(MinX+x*dx,MinY+y*dy);
        c1 = Math.round(max_iteration/4-c);
        c2 = max_iteration-c;
        c3 = ((max_iteration+96-c)<255)?(max_iteration+96-c):255;
        ctx.fillStyle = "rgba("+((c1>0)?c1:0)+","+((c2>0)?c2:0)+","+((c3>0)?c3:0)+","+((max_iteration-c)/max_iteration)+")";
        ctx.translate(x,y);
        ctx.fillRect(0,0,1,1);
        ctx.restore();
      }
  window.status = (((y/sy)*100).toFixed(2))+"%";
  }
  window.status = "100%";
}

var oMinX, oMaxX, oMinY, oMaxY;
function plot(cform) {
  max_iteration = cform.maxi.value;
  MinX = parseFloat(cform.minx.value);
  MaxX = parseFloat(cform.maxx.value);
  MinY = parseFloat(cform.miny.value);
  MaxY = parseFloat(cform.maxy.value);
  dx = (MaxX-MinX)/sx;
  dy = (MaxY-MinY)/sy;
  oMinX = MinX;
  oMaxX = MaxX;
  oMinY = MinY;
  oMaxY = MaxY;
  ctx.fillStyle = "#026";
  ctx.fillRect(0,0,sx,sy);

  plotSet();
  return false;
}


points = new Array();
function selectMinMax(ev) {
	var frm = document.forms[0];
  
  points[points.length] = oMinX+ev.offsetX*dx;
  points[points.length] = oMinY+ev.offsetY*dy;
  if (points.length == 4) {
    if (points[0] >= points[2] ) {
      frm.minx.value = points[2];
      frm.maxx.value = points[0];
    } else {
      frm.minx.value = points[0];
      frm.maxx.value = points[2];
    }
    
    if (points[1] >= points[3]){
      frm.miny.value = points[3];
      frm.maxy.value = points[1];
    } else {
      frm.miny.value = points[1];
      frm.maxy.value = points[3];
    }
    points.length = 0;
  } 
}

function convPNG() {
	var img = document.getElementById("c1").toDataURL();
  var win = window.open(img,"mandel");
}

function resize(frm) {
  var s = frm.res.value.split(/,/);
	document.getElementById("c1").setAttribute("width",s[0]);
  document.getElementById("c1").setAttribute("height",s[1]);
  sx = s[0];
  sy = s[1];

  return false;
}

</script>
</head>
<body>
<p>Click two points, and then "plot" to zoom in</p>
<form onsubmit="return plot(this);">
<label>MinX: <input type="text" name="minx" value="-2"></label>
<label>MaxX: <input type="text" name="maxx" value="1.25"></label>
<label>MinY: <input type="text" name="miny" value="-1.25"></label>
<label>MaxY: <input type="text" name="maxy" value="1.25"></label>
<label>Iter: <input type="text" name="maxi" value="128"></label>
<input type="submit" value="Plot" />
<input type="reset" />
</form>
<form onsubmit="return resize(this)">
<select name="res">
<option value="320,240">320&times;240</option>
<option value="640,480" selected="selected">640&times;480</option>
<option value="800,600">800&times;600</option>
<option value="1024,768">1024&times;768</option>
<option value="1280,960">1280&times;960</option>
<option value="1360,1024">1360&times;1024</option>
<option value="1400,1050">1400&times;1050</option>
<option value="1600,1200">1600&times;1200</option>
</select><input type="submit" value="Change size" /></form>

<p id="actions"><a id="png">Open as PNG</a></p>
</body>
</html>
